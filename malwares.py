from lxml import html
from printf import printf
import requests
import sys

url = 'https://www.malwares.com/api/v2'
apiFile = 'api_key'
f = open(apiFile)
api_key = f.readline()[:-1]
f.close()
reqType = 0
exept = ['--hash', '--upload', '--url']

for opt in sys.argv:
    if opt == '--hash':
        reqType = 1
    elif opt == '--upload':
        reqType = 2
    elif opt == '--url':
        reqType = 3
    elif opt == '--ip':
        reqType = 4

    if reqType == 1 and opt not in exept:
        #hashs.append(opt)
        files = {'file': (opt, open(opt, 'rb'))}
        r = requests.post(url + '/file/upload', files=files, data={'api_key': api_key, 'filename': opt}, timeout=5.0)
        ret = r.json()
        if ret['result_code'] < 1:
            print 'Error: ' + str(ret['result_code'])
        print upload_errors[str(ret['result_code'])]
        print 'file: ' + opt
        print 'md5: ' + ret['md5']
        print 'sha1: ' + ret['sha1']
        print 'sha256: ' + ret['sha256']
    elif reqType == 2 and opt not in exept:
        #data['upload'][opt] = opt
        r = requests.get(url + '/file/mwsinfo', params={'api_key': api_key, 'hash': opt}, timeout=5.0)
        ret = r.json()
        if ret['result_code'] < 1:
            print 'Error: ' + str(ret['result_code'])
        print ret['result_msg']
        print 'hash: ' + opt
        print 'md5: ' + ret['md5']
        print 'sha1: ' + ret['sha1']
        print 'sha256: ' + ret['sha256']
        print 'View count: ' + str(ret['view_count'])
        if ret['black_white'] == 1:
            print 'BLACK LIST'
        elif ret['black_white'] == 2:
            print 'WHITE LIST'
        else:
            print 'Unknown black/white list code'
        print 'filetype: ' + ret['filetype']
        print 'filesize: ' + ret['filesize']
        print 'first seen: ' + ret['first_seen']
        for i in ret['behaviour']:
            print i + ' :'
            if i['security_level'] == 1:
                print 'security level : 1 - Malicious'
            elif i['security_level'] == 2:
                print 'security level : 2 - Dangerous'
            elif i['security_level'] == 3:
                 print 'security level : 3 - Normal'
            else:
                print 'security level : ' + str(i['security_level']) + ' - Unknown'
        print 'taglist: ' + str(ret['taglist'])
    elif reqType == 3 and opt not in exept:
        r = requests.post(url + '/url/info', data={'api_key': api_key, 'url': opt}, timeout=5.0)
        ret = r.json()
        if ret['result_code'] < 1:
            print 'Error: ' + str(ret['result_code'])
        print ret['result_msg']
        if ret['result_code'] == 0:
            rr = rquests.post(url + 'url/request', data={'api_key': api_key, 'url': opt}, timeout=5.0)
            rret = rr.json()
            print 'Url Analysis requested : ' + str(rret['result_code']) + ' - ' + rret['result_msg']
        print 'url : ' + ret['url']
        print 'view count: ' + str(ret['view_count'])
        print 'same hostname :'
        host_list = ret['same_hostname']['list']
        for i in host_list:
            for j in i:
                print '\t' + j + ': ' + str(i[j])
            print
        print 'Total: ' + str(ret['same_hostname']['total'])
    elif reqType == 4 and opt not in exept:
        r = requests.get(url + '/ip/info', params={'api_key': api_key, 'ip': opt}, timeout=5.0)
        print 'IP infos requested for: ' + opt
        ret = r.json()
        print ret['result_msg']
        if ret['result_code'] < 1:
            print 'Error: ' + str(ret['result_code'])
        else:
            print 'ip: ' + ret['ip']
            print 'view count: ' + str(ret['view_count'])
            print
            print 'whois:'
            if 'whois' in ret:
                printf('\t')
                for line in ret['whois']:
                    if line != '\n':
                        printf(line)
                    else:
                        printf('\n\t')
            print
            print 'location:'
            location = ret['location']
            print '\tCity: ' + location['city']
            print '\tCc: ' + location['cc']
            print '\tLongitude: ' + str(location['longitude'])
            print '\tLatitude: ' + str(location['latitude'])
            print '\tCname: ' + location['cname']
            print
            print 'hostname history:'
            if 'hostname_history' in ret:
                liste = ret['hostname_history']['list']
                for j in liste:
                    for i in j:
                        print '\t' + i + ': ' + str(j[i])
                    print
                print '\tTotal: ' + str(ret['hostname_history']['total'])
            else:
                print 'hostname history unavailable...'
            print
            print 'Detected_url:'
            if 'detected_url' in ret:
                liste = ret['detected_url']['list']
                for j in liste:
                    for i in j:
                        print '\t' + i + ': ' + str(j[i])
                    print
                print '\tTotal: ' + str(ret['detected_url']['total'])
            else:
                print 'Detected url unavailable...'
            print
            print 'undetected_url:'
            if 'undetected_url' in ret:
                liste = ret['undetected_url']['list']
                for j in liste:
                    for i in j:
                        print '\t' + i + ': ' + str(j[i])
                    print
                print '\tTotal: ' + str(ret['undetected_url']['total'])
            else:
                print 'Undetected url unavailable...'
            print
            print 'Detected communicating files:'
            if 'detected_communicating_file' in ret:
                com_files = ret['detected_communicating_file']['list']
                for i in com_files:
                    for j in i:
                        print '\t' + j + ': ' + str(i[j])
                    print
                print '\tTotal : ' + str(ret['detected_communicating_file']['total'])
            else:
                print 'Detected communicating files unavailable...'
            print
            print 'Undetected communicating files:'
            if 'undetected_communicating_file' in ret:
                com_files = ret['undetected_communicating_file']['list']
                for i in com_files:
                    for j in i:
                        print '\t' + j + ': ' + str(i[j])
                    print
                print '\tTotal : ' + str(ret['undetected_communicating_file']['total'])
            else:
                print 'Undetected communicating files unavailable...'
            print
            print 'Detected downloaded files:'
            if 'detected_downloaded_file' in ret:
                dl_files = ret['detected_downloaded_file']['list']
                for i in com_files:
                    for j in i:
                        print '\t' + j + ': ' + str(i[j])
                    print
                print '\tTotal : ' + str(ret['detected_downloaded_file']['total'])
            else:
                print 'Detected downloaded files unavailable...'
            print
            print 'Undetected downloaded files:'
            if 'undetected_downloaded_file' in ret:
                dl_files = ret['undetected_downloaded_file']['list']
                for i in com_files:
                    for j in i:
                        print '\t' + j + ': ' + str(i[j])
                    print
                print '\tTotal : ' + str(ret['undetected_downloaded_file']['total'])
            else:
                print 'Undetected downloaded files unavailable...'
